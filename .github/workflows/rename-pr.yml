name: PR

on:
  workflow_call:
    inputs:
      project:
        description: 'Jira project key'
        required: true
        type: string

jobs:
  Rename: # When a PR is opened, check the name is prepended with Jira issue number & update if needed
    runs-on: ubuntu-latest
    steps:
      - name: Skip remaining steps if Dependabot PR # Run this rather than just skipping the whole job, so that we see a green tick in the PR checks
        if: github.event.pull_request.user.login == 'dependabot[bot]'
        id: skip
        run: echo "Run not needed for this PR, skipping remaining steps"

      - name: Checkout code from doctor-power/workflows repo
        uses: actions/checkout@v3
        with:
          repository: doctor-power/workflows
          path: reusable

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install dotenv

      - name: Get Jira issue key from PR branch name
        if: steps.skip.outcome == 'skipped'
        id: get_jira_issue_key
        run: node reusable/.github/workflows/extract_issue_key.js
        env:
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
          PROJECT_KEY: ${{ inputs.project }}

      - name: Check PR title starts with Jira issue key
        if: steps.skip.outcome == 'skipped' && steps.get_jira_issue_key.outcome == 'success'
        id: check_pr_title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          EXPECTED_PREFIX="${{ steps.get_jira_issue_key.outputs.jira_issue_key }}:"
          echo "PR title: $PR_TITLE"
          echo "Expected prefix: $EXPECTED_PREFIX"

          if [[ ! $PR_TITLE =~ ^$EXPECTED_PREFIX ]]; then
            echo "PR title does not start with the Jira issue key."
            exit 1
          else
            echo "PR title starts with the Jira issue key."
          fi

      # If the PR title doesn't start with the Jira issue key, rename the PR
      - name: Rename PR
        if: steps.skip.outcome == 'skipped' && steps.check_pr_title.outcome == 'failure'
        run: |
          gh pr edit ${{ github.event.pull_request.number }} \
            --title "${{ steps.get_jira_issue_key.outputs.jira_issue_key }}: ${{ github.event.pull_request.title }}"
